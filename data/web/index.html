<!DOCTYPE html>
<html lang="de">
<head>
    <title>LED Badge Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="index.css" />
</head>
<body>
<div class="container">
    <div class="nav-buttons">
        <a href="/network">Netzwerk</a>
        <a href="/display">Display</a>
        <a href="/update">OTA Update</a>
    </div>

    <h1>LED Badge Controller</h1>

    <form method="post">
        <div class="card">
            <div class="control-group">
                <label for="mode">LED-Modus</label>
                <select name="mode" id="mode" oninput="updateValue(mode, this.value)">
                    <option value="0">Einfarbig</option>
                    <option value="1">Regenbogen</option>
                    <option value="2">Regenbogen-Welle</option>
                    <option value="3">Farbwisch</option>
                    <option value="4">Theater-Verfolgung</option>
                    <option value="5">Funkeln</option>
                    <option value="6">Feuer</option>
                    <option value="7">Pulsieren</option>
                    <option value="8">Welle</option>
                    <option value="9">Glitzern</option>
                    <option value="10">Gradient</option>
                    <option value="11">Wandernde Punkte</option>
                    <option value="12">Komet</option>
                    <option value="13">Springender Ball</option>
                    <option value="14">Feuerwerk</option>
                    <option value="15">Blitz</option>
                    <option value="16">Konfetti</option>
                    <option value="17">Atmung</option>
                    <option value="18">Regen</option>
                    <option value="19">Matrix</option>
                    <option value="20">Umlaufbahn</option>
                    <option value="21">Spirale</option>
                    <option value="22">Meteorschauer</option>
                    <option value="23">Farbrotation</option>
                    <option value="24">Musik-reaktiv</option>
                </select>
            </div>

            <div class="control-group">
                <div class="color-grid" id="primary">
                </div>
            </div>

            <div class="control-group">
                <div class="color-grid" id="secondary">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="control-group">
                <label for="brightness">Brightness</label>
                <input type="range" id="brightness" min="12" max="255" value="12"
                       oninput="updateValue('brightness', this.value)">
                <div class="value-display"><span id="brightnessValue">12</span></div>
            </div>
        </div>

        <div class="card">
            <div class="control-group">
                <label for="speed">Animation Speed</label>
                <input type="range" id="speed" min="0" max="49" value="30"
                       oninput="updateSpeedValue(this.value)">
                <div class="value-display"><span id="speedValue">20</span>ms</div>
            </div>
        </div>

        <div class="card">
            <div class="control-group">
                <label for="sensitivity">Microphone Sensitivity</label>
                <input type="range" id="sensitivity" min="1" max="50" value="10"
                       oninput="updateValue('sensitivity', this.value)">
                <div class="value-display"><span id="sensitivityValue">10</span></div>
            </div>

            <div class="control-group">
                <label for="frequency">Microphone Frequency Response</label>
                <input type="range" id="frequency" min="10" max="200" value="50"
                       oninput="updateValue('frequency', this.value)">
                <div class="value-display"><span id="frequencyValue">50</span>ms</div>
            </div>
        </div>

        <div class="control-group">
            <button type="submit">&Uuml;bernehmen</button>
        </div>
    </form>

    <div class="card">
        <div class="header-with-status">
            <h2>Akku Status (wip)</h2>
            <div class="battery-status">
                <span id="batteryStatus">Entladen</span>
                <span id="chargingIcon" style="display:none;">&#x26A1;</span>
            </div>
        </div>

        <div class="battery-info">
            <div class="battery-icon">
                <div class="battery-level" id="batteryLevel" style="width:50%"></div>
            </div>
            <div>
                <span id="batteryPercentage">50%</span>
            </div>
        </div>

        <div class="battery-stats">
            <div class="battery-stat">
                <div class="value" id="batteryVoltage">3.7V</div>
                <div class="label">Akku-Spannung</div>
            </div>
            <div class="battery-stat">
                <div class="value" id="batteryCurrent">0 mA</div>
                <div class="label">Ladestrom</div>
            </div>
            <div class="battery-stat">
                <div class="value" id="batteryPower">0 mW</div>
                <div class="label">Leistung</div>
            </div>
            <div class="battery-stat">
                <div class="value" id="batterySystemVoltage">--</div>
                <div class="label">System-Spannung</div>
            </div>
            <div class="battery-stat">
                <div class="value" id="batteryBusVoltage">--</div>
                <div class="label">USB-Spannung</div>
            </div>
            <div class="battery-stat">
                <div class="value" id="batteryChargeStatus">--</div>
                <div class="label">Lade-Status</div>
            </div>
        </div>

        <div style="margin-top: 15px; background: #333; padding: 10px; border-radius: 5px; display: none;">
            <h3 style="margin-top: 0; color: rgb(0, 191, 255);">Register-Werte</h3>
            <div id="registerValues" style="font-family: monospace; font-size: 12px; color: #ddd;"></div>
        </div>

        <div class="control-group">
            <label for="chargeCurrent">Ladestrom</label>
            <select id="chargeCurrent" onchange="setChargeCurrent(this.value)">
                <option value="500">0.5A (500mA)</option>
                <option value="1000">1.0A (1000mA)</option>
                <option value="1500" selected>1.5A (1500mA)</option>
                <option value="2000">2.0A (2000mA)</option>
            </select>
        </div>

        <button type="button" id="ledControlButton" class="led-control-button" onclick="toggleLEDs()">LEDs ausschalten</button>
    </div>

    <div class="card">
        <div class="log-title">
            <h2>System Logs</h2>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('esp')">ESP32 Logs</button>
            <button class="tab-button" onclick="switchTab('bq')">BQ25895 Logs</button>
        </div>

        <div id="esp-logs" class="log-container"></div>
        <div id="bq-logs" class="log-container" style="display: none;"></div>
    </div>

    <!-- Reboot Button -->
    <div style="text-align: center; margin-top: 20px;">
        <button onclick="rebootESP()"
                style="background: #ff6666; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 12px;">
            ESP32 Neustart
        </button>
    </div>
</div>

<script>
    const colors = [
        { hue: 0,   value: 0,   title: "Rot" },
        { hue: 30,  value: 21,  title: "Orange" },
        { hue: 60,  value: 43,  title: "Gelb" },
        { hue: 90,  value: 64,  title: "Gelbgr&uuml;n" },
        { hue: 120, value: 85,  title: "Gr&uuml;n" },
        { hue: 150, value: 107, title: "Gr&uuml;ncyan" },
        { hue: 180, value: 128, title: "Cyan" },
        { hue: 210, value: 149, title: "Blau" },
        { hue: 240, value: 171, title: "Blauviolett" },
        { hue: 270, value: 192, title: "Violett" },
        { hue: 300, value: 213, title: "Magenta" },
        { hue: 330, value: 235, title: "Rosa" },
        { hue: 15,  value: 11,  title: "Rotorange" },
        { hue: 45,  value: 32,  title: "Goldgelb" },
        { hue: 75,  value: 53,  title: "Hellgr&uuml;n" },
        { hue: 195, value: 139, title: "Himmelblau" },
    ];

    const buildColors = (name) => {
        document.getElementById(name).append(
            ...colors.map(({hue, value, title}) => {
                const label = document.createElement('label');
                label.classList.add('color-box');
                label.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
                label.title = title;

                const input = document.createElement('input');
                input.type = "radio";
                input.name = name;
                input.value = value;

                label.appendChild(input);
                return label;
            }),
        );
    }

    buildColors('primary');
    buildColors('secondary');

    let ledsEnabled = true;
    let currentLogType = 'esp';

    let espLogs = [];
    let bqLogs = [];

    const maxLogLines = 100;
    const maxAnimationSpeed = 50; // in ms

    function updateValue(param, value) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `/?param=${param}&value=${value}`, true);
        xhr.send();

        const displayElement = document.getElementById(param + 'Value');
        if (displayElement) {
            displayElement.textContent = value;
        }
    }

    function updateSpeedValue(sliderValue) {
        const invertedValue = maxAnimationSpeed - parseInt(sliderValue);

        const xhr = new XMLHttpRequest();
        xhr.open("GET", `/settings?param=speed&value=${invertedValue}`, true);
        xhr.send();

        const displayElement = document.getElementById('speedValue');
        if (displayElement) {
            displayElement.textContent = invertedValue;
        }
    }

    function toggleLEDs() {
        const button = document.getElementById('ledControlButton');
        ledsEnabled = !ledsEnabled;

        if (ledsEnabled) {
            button.textContent = 'LEDs ausschalten';
            button.classList.remove('on');
        } else {
            button.textContent = 'LEDs einschalten';
            button.classList.add('on');
        }

        fetch(`/toggle-leds?enabled=${ledsEnabled ? 1 : 0}`)
            .then(response => response.text())
            .then(result => {
                console.log('LED-Steuerung: ' + result);
            })
            .catch(error => {
                console.error('Fehler bei LED-Steuerung:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        fetch('/values')
            .then(response => response.json())
            .then(data => {
                const setValue = (name) => {
                    document.getElementById(name).value = data[name];
                    const value = document.getElementById(`${name}Value`);
                    if (value) {
                        value.textContent = data[name];
                    }
                }

                setValue('mode');
                setValue('speed');
                setValue('brightness');
                setValue('sensitivity');
                setValue('frequency');

                if (data.primaryColor !== undefined) {
                    const primaryBoxes = document.querySelectorAll('.control-group:nth-child(2) .color-box');
                    const primaryIndex = Math.floor(data.primaryColor / 16);
                    if (primaryBoxes[primaryIndex]) {
                        primaryBoxes[primaryIndex].classList.add('selected');
                    }
                }
                if (data.secondaryColor !== undefined) {
                    const secondaryBoxes = document.querySelectorAll('.control-group:nth-child(3) .color-box');
                    const secondaryIndex = Math.floor(data.secondaryColor / 16);
                    if (secondaryBoxes[secondaryIndex]) {
                        secondaryBoxes[secondaryIndex].classList.add('selected');
                    }
                }

                if (data.ledsEnabled !== undefined) {
                    ledsEnabled = data.ledsEnabled;
                    const button = document.getElementById('ledControlButton');
                    if (!ledsEnabled) {
                        button.textContent = 'LEDs einschalten';
                        button.classList.add('on');
                    }
                }
            });

        setTimeout(function () {
            updateBatteryInfo();
            fetchLogs();
        }, 500);

        setInterval(updateBatteryInfo, 5000);
        setInterval(fetchLogs, 2000);
    });

    setTimeout(function () {
        console.log('üîÑ Starte Backup-Timer f&uuml;r Akku-Updates');
        updateBatteryInfo();
        fetchLogs();

        setInterval(updateBatteryInfo, 5000);
        setInterval(fetchLogs, 2000);
    }, 3000);

    function updateBatteryInfo() {
        console.log('üîç updateBatteryInfo() gestartet');
        fetch('/battery-status')
            .then(response => {
                console.log('üîç Response erhalten:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üîç Batterie-Daten erhalten:', data);
                // Spannungen
                document.getElementById('batteryVoltage').textContent = data.vbat.toFixed(2) + 'V';
                document.getElementById('batterySystemVoltage').textContent = data.vsys.toFixed(2) + 'V';
                document.getElementById('batteryBusVoltage').textContent = data.vbus.toFixed(2) + 'V';

                // Prozentsatz
                document.getElementById('batteryPercentage').textContent = data.percentage + '%';

                // Batteriestand-Balken aktualisieren
                const batteryLevel = document.getElementById('batteryLevel');
                batteryLevel.style.width = data.percentage + '%';

                // Farbe je nach Ladezustand
                batteryLevel.className = 'battery-level';
                if (data.percentage < 20) {
                    batteryLevel.classList.add('critical');
                } else if (data.percentage < 50) {
                    batteryLevel.classList.add('low');
                }

                // Ladezustand
                const chargingIcon = document.getElementById('chargingIcon');
                if (data.isCharging) {
                    chargingIcon.style.display = 'inline';
                    chargingIcon.innerHTML = '&#x26A1;'; // HTML-kodiertes Blitzsymbol
                    document.getElementById('batteryStatus').textContent = 'Wird geladen';
                } else {
                    chargingIcon.style.display = 'none';
                    document.getElementById('batteryStatus').textContent = 'Entladen';
                }

                document.getElementById('batteryCurrent').textContent = data.ichg.toFixed(0) + ' mA';
                document.getElementById('batteryPower').textContent = data.power.toFixed(3) + ' W';
                document.getElementById('batteryChargeStatus').textContent = data.chargeStatus;
            })
            .catch(error => {
                console.error('‚ùå Fehler beim Abrufen der Akku-Daten:', error);
                document.getElementById('batteryVoltage').textContent = 'Fehler';
                document.getElementById('batteryPercentage').textContent = '?%';
            });
    }

    function setChargeCurrent(mA) {
        fetch(`/set-charge-current?current=${mA}`)
            .then(response => response.text())
            .then(result => {
                console.log('Ladestrom ge&auml;ndert: ' + result);
                addLogEntry('esp', 'Ladestrom auf ' + mA + ' mA gesetzt');
            })
            .catch(error => {
                console.error('Fehler bei Ladestrom-Einstellung:', error);
            });
    }

    function switchTab(logType) {
        document.getElementById('esp-logs').style.display = logType === 'esp' ? 'block' : 'none';
        document.getElementById('bq-logs').style.display = logType === 'bq' ? 'block' : 'none';

        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(btn => {
            btn.classList.remove('active');
        });

        const activeButton = Array.from(buttons).find(btn =>
            btn.textContent.toLowerCase().includes(logType));
        if (activeButton) {
            activeButton.classList.add('active');
        }

        currentLogType = logType;
    }

    function clearLogs() {
        if (currentLogType === 'esp') {
            espLogs = [];
            document.getElementById('esp-logs').innerHTML = '';
        } else {
            bqLogs = [];
            document.getElementById('bq-logs').innerHTML = '';
        }

        // Auch auf dem Server l&ouml;schen
        fetch('/clear-logs?type=' + currentLogType)
            .then(response => response.text())
            .then(result => {
                console.log('Logs gel&ouml;scht: ' + result);
            });
    }

    function addLogEntry(type, message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;

        if (type === 'esp') {
            espLogs.push(logEntry);
            if (espLogs.length > maxLogLines) {
                espLogs.shift();
            }
            updateLogDisplay('esp-logs', espLogs);
        } else {
            bqLogs.push(logEntry);
            if (bqLogs.length > maxLogLines) {
                bqLogs.shift();
            }
            updateLogDisplay('bq-logs', bqLogs);
        }
    }

    function updateLogDisplay(containerId, logs) {
        const container = document.getElementById(containerId);
        const wasScrolledToBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

        container.innerHTML = logs.join('<br>');

        // Check if user did scroll, so we do not jump around
        if (wasScrolledToBottom) {
            container.scrollTop = container.scrollHeight;
        }
    }

    function fetchLogs() {
        console.log('üîç fetchLogs() gestartet');
        fetch('/get-logs')
            .then(response => {
                console.log('üîç Logs Response:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üîç Log-Daten erhalten:', data);
                if (data.esp && data.esp.length > 0) {
                    espLogs = data.esp;
                    updateLogDisplay('esp-logs', espLogs);
                }

                if (data.bq && data.bq.length > 0) {
                    bqLogs = data.bq;
                    updateLogDisplay('bq-logs', bqLogs);
                }
            })
            .catch(error => {
                console.error('‚ùå Fehler beim Abrufen der Logs:', error);
            });
    }

    function rebootESP() {
        if (confirm('ESP32 wirklich neu starten? Die Verbindung wird kurz unterbrochen.')) {
            fetch('/reboot')
                .then(response => response.text())
                .then(result => {
                    alert('ESP32 wird neu gestartet. Bitte warten Sie 10-15 Sekunden und laden Sie die Seite neu.');
                })
                .catch(error => {
                    console.error('Fehler beim Neustart:', error);
                    alert('Neustart wurde gesendet. Bitte warten Sie 10-15 Sekunden und laden Sie die Seite neu.');
                });
        }
    }
</script>
</body>
</html>